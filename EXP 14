<?php
$servername="localhost";
$username="root";
$password="";
$dbname="easytoll";
$conn=new mysqli($servername,$username,$password,$dbname);
if($conn->connect_error) die("Connection failed: ".$conn->connect_error);
session_start();

$action=$_GET['action'] ?? '';

// Register
if($action=='register' && $_SERVER['REQUEST_METHOD']=='POST'){
    $name=$_POST['name']; $email=$_POST['email']; 
    $pass=password_hash($_POST['password'],PASSWORD_DEFAULT);
    $type='user';
    $check=$conn->query("SELECT * FROM users WHERE email='$email'");
    if($check->num_rows>0){ echo "Email exists"; exit; }
    $stmt=$conn->prepare("INSERT INTO users(name,email,password,type) VALUES(?,?,?,?)");
    $stmt->bind_param("ssss",$name,$email,$pass,$type); $stmt->execute();
    echo "Registered! <a href='?page=login'>Login</a>"; exit;
}

// Login
if($action=='login' && $_SERVER['REQUEST_METHOD']=='POST'){
    $email=$_POST['email']; $pass=$_POST['password'];
    $res=$conn->query("SELECT * FROM users WHERE email='$email'");
    if($u=$res->fetch_assoc()){
        if(password_verify($pass,$u['password'])){
            $_SESSION['user_id']=$u['id']; $_SESSION['name']=$u['name']; $_SESSION['type']=$u['type'];
            header("Location:?page=home"); exit;
        } else echo "Wrong password"; exit;
    } else echo "Email not registered"; exit;
}

// Add money to wallet
if($action=='add_money' && isset($_SESSION['user_id'])){
    $amt=$_POST['amount']; $uid=$_SESSION['user_id'];
    $conn->query("UPDATE users SET wallet=wallet+$amt WHERE id=$uid");
    echo "Added $amt to wallet <a href='?page=home'>Home</a>"; exit;
}

// Apply new toll pass
if($action=='apply_pass' && isset($_SESSION['user_id'])){
    $uid=$_SESSION['user_id']; $toll_id=$_POST['toll_gate'];
    $from=date('Y-m-d'); $to=date('Y-m-d',strtotime('+30 days'));
    $qr_code=uniqid("QR");
    $conn->query("INSERT INTO toll_passes(user_id,toll_gate_id,qr_code,valid_from,valid_to) VALUES($uid,$toll_id,'$qr_code','$from','$to')");
    echo "Toll Pass Applied! QR Code: $qr_code <a href='?page=home'>Home</a>"; exit;
}

$page=$_GET['page'] ?? 'home';
?>
<!DOCTYPE html>
<html>
<head>
<title>EasyToll</title>
<style>
body{font-family:Arial;text-align:center;background:#f0f0f0;}
form,div.box{background:#fff;padding:20px;margin:20px auto;width:400px;border-radius:10px;box-shadow:0 0 5px gray;}
input,textarea,button,select{padding:8px;margin:5px;width:90%;}
table{margin:auto;border-collapse:collapse;width:90%;}
td,th{border:1px solid #ccc;padding:8px;}
a{color:blue;text-decoration:none;}
</style>
</head>
<body>
<h2>ðŸš— EasyToll</h2>
<?php
if(isset($_GET['logout'])){ session_destroy(); header("Location:?"); }

// Navigation
if(isset($_SESSION['user_id'])){
    echo "<p>Welcome ".$_SESSION['name']." | <a href='?page=home'>Home</a> | <a href='?page=wallet'>Wallet</a> | <a href='?page=passes'>My Passes</a> | <a href='?logout=1'>Logout</a></p>";
} else echo "<p><a href='?page=register'>Register</a> | <a href='?page=login'>Login</a></p>";

// Pages
if($page=='register'){
    echo "<form method='post' action='?action=register'><h3>Register</h3>
    <input type='text' name='name' placeholder='Name' required><br>
    <input type='email' name='email' placeholder='Email' required><br>
    <input type='password' name='password' placeholder='Password' required><br>
    <button type='submit'>Register</button></form>";
}

if($page=='login'){
    echo "<form method='post' action='?action=login'><h3>Login</h3>
    <input type='email' name='email' placeholder='Email' required><br>
    <input type='password' name='password' placeholder='Password' required><br>
    <button type='submit'>Login</button></form>";
}

if($page=='home' && isset($_SESSION['user_id'])){
    echo "<h3>Welcome to EasyToll</h3>";
    $uid=$_SESSION['user_id'];
    $res=$conn->query("SELECT wallet FROM users WHERE id=$uid");
    $wallet=$res->fetch_assoc()['wallet'];
    echo "<p>Wallet Balance: $wallet</p>";
    echo "<form method='post' action='?action=add_money'><input type='number' name='amount' placeholder='Add Money'><button type='submit'>Add</button></form>";
    
    // Toll pass application
    echo "<h4>Apply Toll Pass</h4><form method='post' action='?action=apply_pass'><select name='toll_gate'>";
    $tolls=$conn->query("SELECT * FROM toll_gates");
    while($t=$tolls->fetch_assoc()) echo "<option value='{$t['id']}'>{$t['name']} - Fee: {$t['fee']}</option>";
    echo "</select><br><button type='submit'>Apply Pass</button></form>";
}

if($page=='wallet' && isset($_SESSION['user_id'])){
    $uid=$_SESSION['user_id'];
    $res=$conn->query("SELECT wallet FROM users WHERE id=$uid");
    echo "<h3>Wallet Balance: ".$res->fetch_assoc()['wallet']."</h3>";
}

if($page=='passes' && isset($_SESSION['user_id'])){
    $uid=$_SESSION['user_id'];
    $res=$conn->query("SELECT tp.*,tg.name AS toll_name FROM toll_passes tp JOIN toll_gates tg ON tp.toll_gate_id=tg.id WHERE tp.user_id=$uid");
    echo "<h3>My Toll Passes</h3><table><tr><th>Toll</th><th>QR Code</th><th>Valid From</th><th>Valid To</th><th>Status</th></tr>";
    while($r=$res->fetch_assoc()){
        echo "<tr><td>{$r['toll_name']}</td><td>{$r['qr_code']}</td><td>{$r['valid_from']}</td><td>{$r['valid_to']}</td><td>{$r['status']}</td></tr>";
    } echo "</table>";
}
?>
</body>
</html>
