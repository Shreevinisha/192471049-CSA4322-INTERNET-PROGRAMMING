<?php
$servername="localhost";
$username="root";
$password="";
$dbname="homefinder";
$conn=new mysqli($servername,$username,$password,$dbname);
if($conn->connect_error) die("Connection failed: ".$conn->connect_error);
session_start();

$action=$_GET['action'] ?? '';

// Register
if($action=='register' && $_SERVER['REQUEST_METHOD']=='POST'){
    $name=$_POST['name']; $email=$_POST['email'];
    $pass=password_hash($_POST['password'],PASSWORD_DEFAULT);
    $check=$conn->query("SELECT * FROM users WHERE email='$email'");
    if($check->num_rows>0){ echo "Email already registered"; exit; }
    $stmt=$conn->prepare("INSERT INTO users(name,email,password) VALUES(?,?,?)");
    $stmt->bind_param("sss",$name,$email,$pass);
    echo $stmt->execute() ? "Registered! <a href='?page=login'>Login</a>" : $conn->error; exit;
}

// Login
if($action=='login' && $_SERVER['REQUEST_METHOD']=='POST'){
    $email=$_POST['email']; $pass=$_POST['password'];
    $res=$conn->query("SELECT * FROM users WHERE email='$email'");
    if($u=$res->fetch_assoc() && password_verify($pass,$u['password'])){
        $_SESSION['uid']=$u['id']; $_SESSION['name']=$u['name']; header("Location:?page=home"); exit;
    } else echo "Invalid login"; exit;
}

// Book property
if($action=='book' && isset($_SESSION['uid'])){
    $uid=$_SESSION['uid']; $pid=$_GET['property_id']; $msg=$_POST['message'] ?? '';
    $stmt=$conn->prepare("INSERT INTO bookings(user_id,property_id,message) VALUES(?,?,?)");
    $stmt->bind_param("iis",$uid,$pid,$msg);
    $stmt->execute();
    echo "Booking request sent! <a href='?page=mybookings'>My Bookings</a>"; exit;
}

$page=$_GET['page'] ?? 'home';
?>
<!DOCTYPE html>
<html>
<head>
<title>Home Finder</title>
<style>
body{font-family:Arial;text-align:center;background:#f0f0f0;}
form,div.box{background:#fff;padding:20px;margin:20px auto;width:400px;border-radius:10px;box-shadow:0 0 5px gray;}
input,textarea,button,select{padding:8px;margin:5px;width:90%;}
table{margin:auto;border-collapse:collapse;width:90%;}
td,th{border:1px solid #ccc;padding:8px;}
a{color:blue;text-decoration:none;}
</style>
</head>
<body>
<h2>üè† Home Finder</h2>
<?php if(isset($_SESSION['uid'])): ?>
<p>Welcome <b><?= $_SESSION['name'] ?></b> | <a href='?page=home'>Home</a> | <a href='?page=mybookings'>My Bookings</a> | <a href='?logout=1'>Logout</a></p>
<?php else: ?>
<p><a href='?page=register'>Register</a> | <a href='?page=login'>Login</a></p>
<?php endif; ?>

<?php
if(isset($_GET['logout'])){ session_destroy(); header("Location:?"); }

if($page=='register'){
    echo '<form method="post" action="?action=register">
    <h3>Register</h3>
    <input type="text" name="name" placeholder="Name" required><br>
    <input type="email" name="email" placeholder="Email" required><br>
    <input type="password" name="password" placeholder="Password" required><br>
    <button type="submit">Register</button></form>';
}

if($page=='login'){
    echo '<form method="post" action="?action=login">
    <h3>Login</h3>
    <input type="email" name="email" placeholder="Email" required><br>
    <input type="password" name="password" placeholder="Password" required><br>
    <button type="submit">Login</button></form>';
}

if($page=='home'){
    $properties=$conn->query("SELECT * FROM properties");
    echo "<h3>Available Properties</h3>";
    while($p=$properties->fetch_assoc()){
        echo "<div class='box'>
        <b>{$p['title']}</b><br>
        Type: {$p['type']}<br>
        Location: {$p['location']}<br>
        Price: {$p['price']}<br>
        Bedrooms: {$p['bedrooms']} | Bathrooms: {$p['bathrooms']}<br>
        Area: {$p['area_sqft']} sqft<br>
        Description: {$p['description']}<br>";
        if(isset($_SESSION['uid'])){
            echo "<form method='post' action='?action=book&property_id={$p['id']}'>
            <textarea name='message' placeholder='Message (optional)'></textarea><br>
            <button type='submit'>Book Property</button></form>";
        } else {
            echo "<a href='?page=login'>Login to Book</a>";
        }
        echo "</div>";
    }
}

if($page=='mybookings' && isset($_SESSION['uid'])){
    $uid=$_SESSION['uid'];
    $bookings=$conn->query("SELECT b.*,p.title,p.location FROM bookings b JOIN properties p ON b.property_id=p.id WHERE b.user_id=$uid ORDER BY b.booking_date DESC");
    echo "<h3>My Bookings</h3><table><tr><th>Property</th><th>Location</th><th>Date</th><th>Message</th></tr>";
    while($b=$bookings->fetch_assoc()){
        echo "<tr><td>{$b['title']}</td><td>{$b['location']}</td><td>{$b['booking_date']}</td><td>{$b['message']}</td></tr>";
    }
    echo "</table>";
}
?>
</body>
</html>
